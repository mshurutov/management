Конфигурации и список параметров СУБД PostgreSQL.
=================================================

`Postgres` может использоваться в следующих конфигурациях:
* одиночный хост;
* связка мастер-реплика;
* отказоустойчивый кластер;

Соответственно, минимальные телодвижения необходимы для одиночного хоста (при этом необходимо учитывать, что к одиночному хосту может быть подключена реплика, или на базе хоста будет развёрнут отказоустойчивый кластер).<BR>
Связка мастер-реплика, помимо базовых настроек, включает в себя настройки репликации.<BR>
Кластерное решение, помимо самого постгреса требует установки и настройки кластерного ПО.

Настройка одиночного хоста.
---------------------------

### Программное обеспечение.

Пакеты, необходимые в любом случае:
* сервер СУБД `PostgresQL`;
* пакет, содержащий `contrib`-ы - поставляемый производителей СУБД набор расширений.

### Настройка операционной системы.

#### Настройка аппаратных средств.

При наличи доступа и возможности конфигурирования необходимо отключать режим `NUMA` в `BIOS`/`EFI flash` материнской платы.

#### Настройка ядра.

Для отключения `NUMA` на уровне ядра необходимо явно отключить этот режим параметром загрузчика (пример для `grub`):
```
pgsrv01 ~ # grep "^GRUB_CMDLINE_LINUX" /etc/default/grub
GRUB_CMDLINE_LINUX="init=/usr/lib/systemd/systemd numa=off"
pgsrv01 ~ #
```

#### Настройка ОС.

* отключить `NUMA` на уровне ОС:
```
vm.zone_reclaim_mode = 0
kernel.numa_balancing = 0
```

* настроить использование памяти:
```
vm.overcommit_memory = 2
vm.overcommit_ratio = 90
vm.swappiness = 5
```

Помимо этого, ведущие эксперты-эксплуатанты настоятельно рекомендуют установить более агрессивные  параметры очистки кэша файловой системы, чтобы не копить изменения, но из вменяемых рекомендаций имеет смысл использовать следующие соображения:
* выставлять `vm.dirty*bytes` вместо `vm.dirty*ratio` на системах с приличными объёмами оперативной памяти;
* выставлять `vm.dirty_background_bytes` таким образом, чтобы фоновые процессы сброса файловых кэшей успевали обработать изменённые страницы прежде, чем будет достигнуто значение `vm.dirty_bytes`;

### Конфигурационные параметры.

```
# Параметры подключения:
listen_addresses = '*'
port = 5432 # Порт может быть нестандартным, например, при использовании проху/пула соединений
max_connections = 100 # максимальное количество подключений, как правило, увеличивается
password_encryption = scram-sha256
# Использование памяти
shared_buffers = <1/4 RAM>
maintenance_work_mem = 1GB # Но надо учитывать количество оперативной памяти
work_mem = 16MB
effective_cache_size = <1/2 RAM>
# WAL-ы, репликация и прочие бекапы
archive_command = '/bin/true'
archive_mode = on # чтобы не перезапускать экземпляр, когда понадобится
# Следующие два параметра - из разряда не полагаться на умолчания
max_replication_slots = 10
max_wal_senders = 10
hot_standby = on
wal_level = replica
# (auto)?vacuum
autovacuum_analyze_scale_factor = 0.01
autovacuum_vacuum_scale_factor = 0.05
# Logging
lc_messages = 'en_US.UTF-8'
log_destination = 'stderr'
log_file_mode = 0640 # очень часто надо дать доступ к логам агенту системы мониторинга
log_filename = 'postgresql-%a.log'
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
logging_collector = on # если не включить, 
# различные параметры
restart_after_crash = false # умерла так умерла
# Не забыть поставить в крон очистку статистики
shared_preload_libraries = 'pg_stat_statements'
```
Все остальные параметры должны настраиваться под конкретную конфигурацию железа и планируемую нагрузку.

Замечания по автовакууму. Когда таблица очень большая, имеет смысл вообще обнулить для этой таблицы `autovacuum_analyze_scale_factor` и `autovacuum_vacuum_scale_factor`, выставив какое-то вменяемое значение для `autovacuum_analyze_threshold` и `autovacuum_vacuum_threshold` соответственно.

### Параметры `pg_hba.conf`.

```
local all         postgres              peer
host  all         all      127.0.0.1/32 scram-sha256
host  all         all      ::1/128      scram-sha256
host  all         postgres 0.0.0.0/0    reject
host  replication repluser samenet      scram-sha256
host  all         all      samenet      scram-sha256
```

Кластеры. `Patroni`.
------------------

Кластеры. `Srolon`.
-----------------

Кластеры. `Corosync+pacemaker`.
-----------------------------


